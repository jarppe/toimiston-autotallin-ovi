<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta viewport="width=device-width, initial-scale=1.0"/>
    <title>Toimiston autotallin ovi</title>
    <style>
      html, body {
        width: 100%;
        height: 100%;
        border: 0;
        margin: 0;
        background: #aaa;
      }
      body {
        display: flex;
        flex-direction: row;
        justify-content: center;
      }
      #button {
        flex: 1;
        width: 50%;
        margin: auto;
        border-radius: 50%;
        border: 0.5rem solid black;
        background: red;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center; 
      }
      #button:before {
        content: "";
        display: block;
        padding-top: 100%;
      }
      #button span {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 60px;
      }
    </style>
  </head>
  <body>
    <div id="button">
      <span id="message">OPEN</span>
    </div>
    <script>
      const query = window
        .location
        .search
        .substring(1)
        .split("&")
        .reduce((params, param) => {
           let [key, value] = param.split("=");
           params[key] = value ? decodeURIComponent(value.replace(/\+/g, " ")) : null;
           return params;
        }, {});

      const passkey = query["passkey"],
            fetchOpts = {
              mode: "no-cors",
              method: "POST",
              body: JSON.stringify({passkey: passkey}),
              headers: {
                "Content-Type": "application/json"
              }
            },
            url = "https://0u41eh32ei.execute-api.eu-central-1.amazonaws.com/default/autohalli",
            message = document.getElementById("message");
      
      const READY = "CLICK TO OPEN",
            OPENING = "...",
            DONE = "DOOR OPENING",
            ERROR = "FAIL";

      var state = READY;

      const setState = newState => {
        state = newState;
        message.innerText = state;
      }

      const openDoor = () => {
        setState(OPENING);
        fetch(url, fetchOpts)
          .then(resp => { 
            console.log("resp:", resp); 
            setState(DONE); 
          })
          .catch(e => { 
            console.log("error:", e); 
            setState(ERROR); 
          });
      }

      const click = () => {
        if (state === READY) {
          openDoor();
        } else {
          setState(READY);
        }
      }

      document.getElementById("button").onclick = click;
    </script>
  </body>
</html>